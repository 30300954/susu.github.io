<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»å½±å¦å…‹å›¾ç‰‡ç”Ÿæˆå™¨ - ä¿®å¤ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #1a2a6c;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .panel-title {
            color: #1a2a6c;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e74c3c;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            background-color: #f0f8ff;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #e74c3c;
            background-color: #fff0f0;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #555;
        }
        
        .upload-hint {
            color: #888;
            font-size: 0.9rem;
        }
        
        .image-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        
        .preview-box {
            width: 200px;
            height: 200px;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .preview-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1a2a6c;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        select, input[type="range"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .slider-value {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-generate {
            background: linear-gradient(to right, #3498db, #1a2a6c);
            color: white;
        }
        
        .btn-generate:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-download {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-download:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .result-container {
            margin-top: 30px;
        }
        
        .result-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        
        .result-canvas-container {
            position: relative;
            width: 300px;
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        
        .result-canvas {
            width: 100%;
            height: 100%;
        }
        
        .bg-toggle {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .bg-btn {
            padding: 10px 20px;
            border: 2px solid #3498db;
            border-radius: 5px;
            background-color: white;
            color: #3498db;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .bg-btn.active {
            background-color: #3498db;
            color: white;
        }
        
        .bg-btn:hover {
            transform: translateY(-2px);
        }
        
        .bg-white {
            background-color: white;
        }
        
        .bg-black {
            background-color: black;
        }
        
        .info-box {
            background-color: #e8f4fc;
            border-left: 4px solid #3498db;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .info-title {
            color: #1a2a6c;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .info-content {
            color: #555;
            line-height: 1.5;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .advanced-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .slider-label {
            min-width: 120px;
            font-weight: bold;
        }
        
        .slider-input {
            flex: 1;
        }
        
        .reset-btn {
            padding: 8px 15px;
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .reset-btn:hover {
            background-color: #7f8c8d;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        
        .status-message {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å¹»å½±å¦å…‹å›¾ç‰‡ç”Ÿæˆå™¨ - ä¿®å¤ç‰ˆ</h1>
            <p class="subtitle">ä¿®å¤äº†å›¾ç‰‡ä¸‹è½½åŠŸèƒ½ï¼Œç°åœ¨å¯ä»¥æ­£å¸¸ä¸‹è½½ç”Ÿæˆçš„å¹»å½±å¦å…‹å›¾ç‰‡</p>
        </header>
        
        <div class="app-container">
            <!-- å·¦ä¾§ï¼šå›¾ç‰‡ä¸Šä¼ å’Œè®¾ç½® -->
            <div class="panel">
                <h2 class="panel-title">å›¾ç‰‡ä¸Šä¼ ä¸è®¾ç½®</h2>
                
                <!-- è¡¨å›¾ä¸Šä¼ åŒºåŸŸ -->
                <div class="control-group">
                    <label>è¡¨å›¾ï¼ˆç™½è‰²èƒŒæ™¯æ˜¾ç¤ºï¼‰ï¼š</label>
                    <div class="upload-area" id="uploadArea1">
                        <div class="upload-icon">ğŸ–¼ï¸</div>
                        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ”¾ä¸Šä¼ è¡¨å›¾</div>
                        <div class="upload-hint">æ”¯æŒPNGã€JPGã€JPEGæ ¼å¼</div>
                        <input type="file" id="image1" accept="image/*" class="hidden">
                    </div>
                    <div class="image-preview">
                        <div class="preview-label">è¡¨å›¾é¢„è§ˆï¼š</div>
                        <div class="preview-box">
                            <img id="preview1" src="" alt="è¡¨å›¾é¢„è§ˆ" class="hidden">
                            <div id="placeholder1">æš‚æ— å›¾ç‰‡</div>
                        </div>
                    </div>
                </div>
                
                <!-- é‡Œå›¾ä¸Šä¼ åŒºåŸŸ -->
                <div class="control-group">
                    <label>é‡Œå›¾ï¼ˆé»‘è‰²èƒŒæ™¯æ˜¾ç¤ºï¼‰ï¼š</label>
                    <div class="upload-area" id="uploadArea2">
                        <div class="upload-icon">ğŸ–¼ï¸</div>
                        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ”¾ä¸Šä¼ é‡Œå›¾</div>
                        <div class="upload-hint">æ”¯æŒPNGã€JPGã€JPEGæ ¼å¼</div>
                        <input type="file" id="image2" accept="image/*" class="hidden">
                    </div>
                    <div class="image-preview">
                        <div class="preview-label">é‡Œå›¾é¢„è§ˆï¼š</div>
                        <div class="preview-box">
                            <img id="preview2" src="" alt="é‡Œå›¾é¢„è§ˆ" class="hidden">
                            <div id="placeholder2">æš‚æ— å›¾ç‰‡</div>
                        </div>
                    </div>
                </div>
                
                <!-- åŸºæœ¬å‚æ•°è®¾ç½® -->
                <div class="control-group">
                    <label>è¾“å‡ºå°ºå¯¸ï¼š</label>
                    <select id="outputSize">
                        <option value="original">ä¿æŒåŸå›¾å°ºå¯¸</option>
                        <option value="512">512Ã—512 åƒç´ </option>
                        <option value="1024">1024Ã—1024 åƒç´ </option>
                        <option value="800x600">800Ã—600 åƒç´ </option>
                        <option value="1200x900">1200Ã—900 åƒç´ </option>
                    </select>
                </div>
                
                <!-- é«˜çº§æ§åˆ¶å‚æ•° -->
                <div class="advanced-controls">
                    <h3 style="margin-bottom: 15px; color: #1a2a6c;">é«˜çº§å‚æ•°è°ƒèŠ‚</h3>
                    
                    <!-- è¡¨å›¾äº®åº¦æ§åˆ¶ -->
                    <div class="slider-container">
                        <div class="slider-label">è¡¨å›¾äº®åº¦ï¼š<span id="brightness1Value" class="slider-value">0%</span></div>
                        <input type="range" id="brightness1" min="-100" max="100" value="0" class="slider-input">
                    </div>
                    
                    <!-- é‡Œå›¾äº®åº¦æ§åˆ¶ -->
                    <div class="slider-container">
                        <div class="slider-label">é‡Œå›¾äº®åº¦ï¼š<span id="brightness2Value" class="slider-value">0%</span></div>
                        <input type="range" id="brightness2" min="-100" max="100" value="0" class="slider-input">
                    </div>
                    
                    <!-- è¡¨å›¾å¯¹æ¯”åº¦æ§åˆ¶ -->
                    <div class="slider-container">
                        <div class="slider-label">è¡¨å›¾å¯¹æ¯”åº¦ï¼š<span id="contrast1Value" class="slider-value">0%</span></div>
                        <input type="range" id="contrast1" min="-50" max="100" value="0" class="slider-input">
                    </div>
                    
                    <!-- é‡Œå›¾å¯¹æ¯”åº¦æ§åˆ¶ -->
                    <div class="slider-container">
                        <div class="slider-label">é‡Œå›¾å¯¹æ¯”åº¦ï¼š<span id="contrast2Value" class="slider-value">0%</span></div>
                        <input type="range" id="contrast2" min="-50" max="100" value="0" class="slider-input">
                    </div>
                    
                    <!-- è‰²å½©æ¯”ä¾‹æ§åˆ¶ -->
                    <div class="slider-container">
                        <div class="slider-label">è‰²å½©æ¯”ä¾‹ï¼š<span id="colorRatioValue" class="slider-value">50%</span></div>
                        <input type="range" id="colorRatio" min="0" max="100" value="50" class="slider-input">
                    </div>
                    
                    <!-- äº®åº¦æ¯”ä¾‹æ§åˆ¶ -->
                    <div class="slider-container">
                        <div class="slider-label">äº®åº¦æ¯”ä¾‹ï¼š<span id="brightnessRatioValue" class="slider-value">50%</span></div>
                        <input type="range" id="brightnessRatio" min="0" max="100" value="50" class="slider-input">
                    </div>
                    
                    <!-- é€æ˜åº¦å¼ºåº¦æ§åˆ¶ -->
                    <div class="slider-container">
                        <div class="slider-label">é€æ˜åº¦å¼ºåº¦ï¼š<span id="alphaStrengthValue" class="slider-value">100%</span></div>
                        <input type="range" id="alphaStrength" min="1" max="200" value="100" class="slider-input">
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="reset-btn" id="resetParams">é‡ç½®æ‰€æœ‰å‚æ•°</button>
                    </div>
                </div>
                
                <div class="buttons">
                    <button id="generateBtn" class="btn-generate">ç”Ÿæˆå¹»å½±å¦å…‹å›¾ç‰‡</button>
                </div>
                
                <!-- çŠ¶æ€æ¶ˆæ¯ -->
                <div id="statusMessage" class="status-message hidden"></div>
                
                <!-- åŠ è½½æç¤º -->
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨ç”Ÿæˆå¹»å½±å¦å…‹å›¾ç‰‡...</div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šç»“æœé¢„è§ˆå’Œä¸‹è½½ -->
            <div class="panel">
                <h2 class="panel-title">ç»“æœé¢„è§ˆä¸ä¸‹è½½</h2>
                
                <div class="result-preview">
                    <div class="bg-toggle">
                        <button class="bg-btn active" id="whiteBgBtn">ç™½è‰²èƒŒæ™¯</button>
                        <button class="bg-btn" id="blackBgBtn">é»‘è‰²èƒŒæ™¯</button>
                    </div>
                    
                    <div class="result-canvas-container bg-white" id="resultContainer">
                        <canvas id="resultCanvas" class="result-canvas"></canvas>
                    </div>
                    
                    <div class="buttons">
                        <button id="downloadBtn" class="btn-download" disabled>ä¸‹è½½PNGå›¾ç‰‡</button>
                    </div>
                </div>
                
                <div class="info-box">
                    <div class="info-title">ä½¿ç”¨è¯´æ˜ï¼š</div>
                    <div class="info-content">
                        <strong>å‚æ•°è¯´æ˜ï¼š</strong><br>
                        1. <strong>è¡¨å›¾äº®åº¦/é‡Œå›¾äº®åº¦</strong>ï¼šåˆ†åˆ«è°ƒæ•´ä¸¤å¼ å›¾ç‰‡çš„äº®åº¦ï¼ˆ-100%åˆ°+100%ï¼‰<br>
                        2. <strong>è¡¨å›¾å¯¹æ¯”åº¦/é‡Œå›¾å¯¹æ¯”åº¦</strong>ï¼šåˆ†åˆ«è°ƒæ•´ä¸¤å¼ å›¾ç‰‡çš„å¯¹æ¯”åº¦<br>
                        3. <strong>è‰²å½©æ¯”ä¾‹</strong>ï¼šæ§åˆ¶è¡¨å›¾å’Œé‡Œå›¾åœ¨æ··åˆæ—¶çš„è‰²å½©æƒé‡ï¼ˆ0%åå‘è¡¨å›¾ï¼Œ100%åå‘é‡Œå›¾ï¼‰<br>
                        4. <strong>äº®åº¦æ¯”ä¾‹</strong>ï¼šæ§åˆ¶è¡¨å›¾å’Œé‡Œå›¾åœ¨æ··åˆæ—¶çš„äº®åº¦æƒé‡<br>
                        5. <strong>é€æ˜åº¦å¼ºåº¦</strong>ï¼šæ§åˆ¶æ··åˆæ•ˆæœçš„å¼ºåº¦ï¼Œå€¼è¶Šå¤§æ•ˆæœè¶Šæ˜æ˜¾<br>
                        <br>
                        <strong>æç¤ºï¼š</strong>ç”Ÿæˆçš„å›¾ç‰‡æ˜¯é€æ˜çš„PNGæ ¼å¼ï¼Œåœ¨ä¸åŒèƒŒæ™¯è‰²ä¸‹ä¼šæ˜¾ç¤ºä¸åŒå†…å®¹
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>å¹»å½±å¦å…‹å›¾ç‰‡ç”Ÿæˆå™¨ v3.0 | å·²ä¿®å¤ä¸‹è½½åŠŸèƒ½ | åŸºäºHTML5 Canvaså®ç°</p>
        </footer>
    </div>

    <script>
        // DOMå…ƒç´ 
        const image1Input = document.getElementById('image1');
        const image2Input = document.getElementById('image2');
        const preview1 = document.getElementById('preview1');
        const preview2 = document.getElementById('preview2');
        const placeholder1 = document.getElementById('placeholder1');
        const placeholder2 = document.getElementById('placeholder2');
        const uploadArea1 = document.getElementById('uploadArea1');
        const uploadArea2 = document.getElementById('uploadArea2');
        const outputSizeSelect = document.getElementById('outputSize');
        
        // é«˜çº§å‚æ•°æ»‘å—
        const brightness1Slider = document.getElementById('brightness1');
        const brightness2Slider = document.getElementById('brightness2');
        const contrast1Slider = document.getElementById('contrast1');
        const contrast2Slider = document.getElementById('contrast2');
        const colorRatioSlider = document.getElementById('colorRatio');
        const brightnessRatioSlider = document.getElementById('brightnessRatio');
        const alphaStrengthSlider = document.getElementById('alphaStrength');
        
        // å‚æ•°å€¼æ˜¾ç¤º
        const brightness1Value = document.getElementById('brightness1Value');
        const brightness2Value = document.getElementById('brightness2Value');
        const contrast1Value = document.getElementById('contrast1Value');
        const contrast2Value = document.getElementById('contrast2Value');
        const colorRatioValue = document.getElementById('colorRatioValue');
        const brightnessRatioValue = document.getElementById('brightnessRatioValue');
        const alphaStrengthValue = document.getElementById('alphaStrengthValue');
        
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const whiteBgBtn = document.getElementById('whiteBgBtn');
        const blackBgBtn = document.getElementById('blackBgBtn');
        const resultContainer = document.getElementById('resultContainer');
        const resultCanvas = document.getElementById('resultCanvas');
        const loading = document.getElementById('loading');
        const resetParamsBtn = document.getElementById('resetParams');
        const statusMessage = document.getElementById('statusMessage');
        
        // å…¨å±€å˜é‡
        let image1 = null;
        let image2 = null;
        let ctx = resultCanvas.getContext('2d');
        let mirageImageData = null;
        let isImageGenerated = false;
        
        // äº‹ä»¶ç›‘å¬å™¨
        uploadArea1.addEventListener('click', () => image1Input.click());
        uploadArea2.addEventListener('click', () => image2Input.click());
        
        image1Input.addEventListener('change', (e) => handleImageUpload(e, 1));
        image2Input.addEventListener('change', (e) => handleImageUpload(e, 2));
        
        // æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
        brightness1Slider.addEventListener('input', () => {
            brightness1Value.textContent = `${brightness1Slider.value > 0 ? '+' : ''}${brightness1Slider.value}%`;
        });
        
        brightness2Slider.addEventListener('input', () => {
            brightness2Value.textContent = `${brightness2Slider.value > 0 ? '+' : ''}${brightness2Slider.value}%`;
        });
        
        contrast1Slider.addEventListener('input', () => {
            contrast1Value.textContent = `${contrast1Slider.value > 0 ? '+' : ''}${contrast1Slider.value}%`;
        });
        
        contrast2Slider.addEventListener('input', () => {
            contrast2Value.textContent = `${contrast2Slider.value > 0 ? '+' : ''}${contrast2Slider.value}%`;
        });
        
        colorRatioSlider.addEventListener('input', () => {
            colorRatioValue.textContent = `${colorRatioSlider.value}%`;
        });
        
        brightnessRatioSlider.addEventListener('input', () => {
            brightnessRatioValue.textContent = `${brightnessRatioSlider.value}%`;
        });
        
        alphaStrengthSlider.addEventListener('input', () => {
            alphaStrengthValue.textContent = `${alphaStrengthSlider.value}%`;
        });
        
        generateBtn.addEventListener('click', generateMirageTank);
        downloadBtn.addEventListener('click', downloadImage);
        whiteBgBtn.addEventListener('click', () => switchBackground('white'));
        blackBgBtn.addEventListener('click', () => switchBackground('black'));
        resetParamsBtn.addEventListener('click', resetAllParams);
        
        // æ‹–æ”¾ä¸Šä¼ åŠŸèƒ½
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea1.addEventListener(eventName, preventDefaults, false);
            uploadArea2.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea1.addEventListener(eventName, () => uploadArea1.style.borderColor = '#e74c3c', false);
            uploadArea2.addEventListener(eventName, () => uploadArea2.style.borderColor = '#e74c3c', false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea1.addEventListener(eventName, () => uploadArea1.style.borderColor = '#3498db', false);
            uploadArea2.addEventListener(eventName, () => uploadArea2.style.borderColor = '#3498db', false);
        });
        
        uploadArea1.addEventListener('drop', (e) => handleDrop(e, 1), false);
        uploadArea2.addEventListener('drop', (e) => handleDrop(e, 2), false);
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event, imageNumber) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        if (imageNumber === 1) {
                            image1 = img;
                            preview1.src = e.target.result;
                            preview1.classList.remove('hidden');
                            placeholder1.classList.add('hidden');
                        } else {
                            image2 = img;
                            preview2.src = e.target.result;
                            preview2.classList.remove('hidden');
                            placeholder2.classList.add('hidden');
                        }
                        
                        // å¦‚æœä¸¤å¼ å›¾ç‰‡éƒ½å·²ä¸Šä¼ ï¼Œå¯ç”¨ç”ŸæˆæŒ‰é’®
                        if (image1 && image2) {
                            generateBtn.disabled = false;
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // å¤„ç†æ‹–æ”¾ä¸Šä¼ 
        function handleDrop(e, imageNumber) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file && file.type.startsWith('image/')) {
                if (imageNumber === 1) {
                    image1Input.files = dt.files;
                    handleImageUpload({target: {files: dt.files}}, 1);
                } else {
                    image2Input.files = dt.files;
                    handleImageUpload({target: {files: dt.files}}, 2);
                }
            }
        }
        
        // åˆ‡æ¢èƒŒæ™¯é¢œè‰²
        function switchBackground(color) {
            if (color === 'white') {
                resultContainer.className = 'result-canvas-container bg-white';
                whiteBgBtn.classList.add('active');
                blackBgBtn.classList.remove('active');
            } else {
                resultContainer.className = 'result-canvas-container bg-black';
                whiteBgBtn.classList.remove('active');
                blackBgBtn.classList.add('active');
            }
        }
        
        // é‡ç½®æ‰€æœ‰å‚æ•°
        function resetAllParams() {
            brightness1Slider.value = 0;
            brightness2Slider.value = 0;
            contrast1Slider.value = 0;
            contrast2Slider.value = 0;
            colorRatioSlider.value = 50;
            brightnessRatioSlider.value = 50;
            alphaStrengthSlider.value = 100;
            
            brightness1Value.textContent = '0%';
            brightness2Value.textContent = '0%';
            contrast1Value.textContent = '0%';
            contrast2Value.textContent = '0%';
            colorRatioValue.textContent = '50%';
            brightnessRatioValue.textContent = '50%';
            alphaStrengthValue.textContent = '100%';
            
            // é‡æ–°ç”Ÿæˆå›¾ç‰‡
            if (image1 && image2) {
                generateMirageTank();
            }
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatusMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message';
            
            if (type === 'success') {
                statusMessage.classList.add('status-success');
            } else if (type === 'error') {
                statusMessage.classList.add('status-error');
            } else if (type === 'info') {
                statusMessage.classList.add('status-info');
            }
            
            statusMessage.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }
        
        // åº”ç”¨äº®åº¦å’Œå¯¹æ¯”åº¦è°ƒæ•´
        function applyBrightnessContrast(imageData, brightness, contrast) {
            const data = imageData.data;
            const brightnessFactor = brightness / 100;
            const contrastFactor = (contrast + 100) / 100;
            
            for (let i = 0; i < data.length; i += 4) {
                // åº”ç”¨å¯¹æ¯”åº¦
                data[i] = (data[i] - 128) * contrastFactor + 128;
                data[i + 1] = (data[i + 1] - 128) * contrastFactor + 128;
                data[i + 2] = (data[i + 2] - 128) * contrastFactor + 128;
                
                // åº”ç”¨äº®åº¦
                data[i] = Math.max(0, Math.min(255, data[i] + brightnessFactor * 255));
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + brightnessFactor * 255));
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + brightnessFactor * 255));
            }
            
            return imageData;
        }
        
        // ç”Ÿæˆå¹»å½±å¦å…‹å›¾ç‰‡
        function generateMirageTank() {
            if (!image1 || !image2) {
                showStatusMessage('è¯·å…ˆä¸Šä¼ ä¸¤å¼ å›¾ç‰‡ï¼', 'error');
                return;
            }
            
            loading.classList.remove('hidden');
            downloadBtn.disabled = true;
            isImageGenerated = false;
            
            // ä½¿ç”¨setTimeoutç¡®ä¿UIæ›´æ–°
            setTimeout(() => {
                try {
                    // è·å–è¾“å‡ºå°ºå¯¸
                    const outputSize = outputSizeSelect.value;
                    let width, height;
                    
                    if (outputSize === 'original') {
                        // ä½¿ç”¨æœ€å¤§å›¾ç‰‡å°ºå¯¸
                        width = Math.max(image1.width, image2.width);
                        height = Math.max(image1.height, image2.height);
                    } else if (outputSize === '512') {
                        width = 512;
                        height = 512;
                    } else if (outputSize === '1024') {
                        width = 1024;
                        height = 1024;
                    } else if (outputSize === '800x600') {
                        width = 800;
                        height = 600;
                    } else if (outputSize === '1200x900') {
                        width = 1200;
                        height = 900;
                    } else {
                        width = 800;
                        height = 600;
                    }
                    
                    // è®¾ç½®Canvaså°ºå¯¸
                    resultCanvas.width = width;
                    resultCanvas.height = height;
                    
                    // è·å–å‚æ•°å€¼
                    const brightness1 = parseInt(brightness1Slider.value) / 100;
                    const brightness2 = parseInt(brightness2Slider.value) / 100;
                    const contrast1 = parseInt(contrast1Slider.value);
                    const contrast2 = parseInt(contrast2Slider.value);
                    const colorRatio = parseInt(colorRatioSlider.value) / 100; // 0-1
                    const brightnessRatio = parseInt(brightnessRatioSlider.value) / 100; // 0-1
                    const alphaStrength = parseInt(alphaStrengthSlider.value) / 100;
                    
                    // åˆ›å»ºä¸´æ—¶Canvaså¤„ç†å›¾ç‰‡
                    const tempCanvas1 = document.createElement('canvas');
                    const tempCtx1 = tempCanvas1.getContext('2d');
                    tempCanvas1.width = width;
                    tempCanvas1.height = height;
                    
                    const tempCanvas2 = document.createElement('canvas');
                    const tempCtx2 = tempCanvas2.getContext('2d');
                    tempCanvas2.width = width;
                    tempCanvas2.height = height;
                    
                    // ç»˜åˆ¶å›¾ç‰‡åˆ°ä¸´æ—¶Canvas
                    tempCtx1.drawImage(image1, 0, 0, width, height);
                    tempCtx2.drawImage(image2, 0, 0, width, height);
                    
                    // è·å–å›¾ç‰‡æ•°æ®
                    let imageData1 = tempCtx1.getImageData(0, 0, width, height);
                    let imageData2 = tempCtx2.getImageData(0, 0, width, height);
                    
                    // åº”ç”¨äº®åº¦å’Œå¯¹æ¯”åº¦è°ƒæ•´
                    imageData1 = applyBrightnessContrast(imageData1, brightness1, contrast1);
                    imageData2 = applyBrightnessContrast(imageData2, brightness2, contrast2);
                    
                    // åˆ›å»ºç»“æœå›¾ç‰‡æ•°æ®
                    mirageImageData = ctx.createImageData(width, height);
                    
                    // å¹»å½±å¦å…‹ç®—æ³•ï¼ˆå¢å¼ºç‰ˆï¼‰
                    for (let i = 0; i < imageData1.data.length; i += 4) {
                        // è·å–è¡¨å›¾åƒç´ 
                        const r1 = imageData1.data[i];
                        const g1 = imageData1.data[i + 1];
                        const b1 = imageData1.data[i + 2];
                        
                        // è·å–é‡Œå›¾åƒç´ 
                        const r2 = imageData2.data[i];
                        const g2 = imageData2.data[i + 1];
                        const b2 = imageData2.data[i + 2];
                        
                        // è®¡ç®—äº®åº¦ï¼ˆè€ƒè™‘äº®åº¦æ¯”ä¾‹ï¼‰
                        const luminance1 = (0.299 * r1 + 0.587 * g1 + 0.114 * b1) * brightnessRatio;
                        const luminance2 = (0.299 * r2 + 0.587 * g2 + 0.114 * b2) * (1 - brightnessRatio);
                        
                        // è®¡ç®—alphaå€¼ï¼ˆé€æ˜åº¦ï¼‰ï¼Œè€ƒè™‘é€æ˜åº¦å¼ºåº¦
                        let alpha = 255 - (luminance1 - luminance2) * alphaStrength;
                        alpha = Math.max(0, Math.min(255, alpha));
                        
                        // è®¡ç®—é¢œè‰²å€¼ï¼ˆè€ƒè™‘è‰²å½©æ¯”ä¾‹ï¼‰
                        let r, g, b;
                        
                        if (alpha === 0) {
                            r = g = b = 0;
                        } else {
                            // æ··åˆè¡¨å›¾å’Œé‡Œå›¾çš„é¢œè‰²
                            const mixedR = r1 * (1 - colorRatio) + r2 * colorRatio;
                            const mixedG = g1 * (1 - colorRatio) + g2 * colorRatio;
                            const mixedB = b1 * (1 - colorRatio) + b2 * colorRatio;
                            
                            r = Math.min(255, Math.max(0, (mixedR * 255) / alpha));
                            g = Math.min(255, Math.max(0, (mixedG * 255) / alpha));
                            b = Math.min(255, Math.max(0, (mixedB * 255) / alpha));
                        }
                        
                        // è®¾ç½®ç»“æœåƒç´ 
                        mirageImageData.data[i] = Math.round(r);
                        mirageImageData.data[i + 1] = Math.round(g);
                        mirageImageData.data[i + 2] = Math.round(b);
                        mirageImageData.data[i + 3] = Math.round(alpha);
                    }
                    
                    // å°†ç»“æœç»˜åˆ¶åˆ°Canvas
                    ctx.putImageData(mirageImageData, 0, 0);
                    
                    // å¯ç”¨ä¸‹è½½æŒ‰é’®
                    downloadBtn.disabled = false;
                    isImageGenerated = true;
                    
                    loading.classList.add('hidden');
                    showStatusMessage('å¹»å½±å¦å…‹å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼', 'success');
                    
                } catch (error) {
                    console.error('ç”Ÿæˆå¹»å½±å¦å…‹å›¾ç‰‡æ—¶å‡ºé”™:', error);
                    showStatusMessage('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼', 'error');
                    loading.classList.add('hidden');
                }
            }, 100);
        }
        
        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            if (!isImageGenerated) {
                showStatusMessage('è¯·å…ˆç”Ÿæˆå¹»å½±å¦å…‹å›¾ç‰‡ï¼', 'error');
                return;
            }
            
            try {
                // æ£€æŸ¥Canvasæ˜¯å¦æœ‰å†…å®¹
                if (resultCanvas.width === 0 || resultCanvas.height === 0) {
                    showStatusMessage('Canvasä¸ºç©ºï¼Œè¯·å…ˆç”Ÿæˆå›¾ç‰‡ï¼', 'error');
                    return;
                }
                
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥
                const link = document.createElement('a');
                
                // è®¾ç½®ä¸‹è½½çš„æ–‡ä»¶å
                const timestamp = new Date().getTime();
                link.download = `å¹»å½±å¦å…‹å›¾ç‰‡_${timestamp}.png`;
                
                // å°†Canvasè½¬æ¢ä¸ºDataURL
                const dataURL = resultCanvas.toDataURL('image/png');
                
                // è®¾ç½®é“¾æ¥çš„hrefä¸ºDataURL
                link.href = dataURL;
                
                // å°†é“¾æ¥æ·»åŠ åˆ°æ–‡æ¡£ä¸­ï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ï¼‰
                document.body.appendChild(link);
                
                // æ¨¡æ‹Ÿç‚¹å‡»é“¾æ¥
                link.click();
                
                // ä»æ–‡æ¡£ä¸­ç§»é™¤é“¾æ¥
                document.body.removeChild(link);
                
                showStatusMessage('å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:', error);
                showStatusMessage('ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ï¼', 'error');
            }
        }
        
        // åˆå§‹åŒ–Canvaså°ºå¯¸
        resultCanvas.width = 300;
        resultCanvas.height = 300;
        
        // ç»˜åˆ¶åˆå§‹æç¤º
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(0, 0, 300, 300);
        ctx.fillStyle = '#999';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ç”Ÿæˆåé¢„è§ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ', 150, 150);
        
        // åˆå§‹çŠ¶æ€
        generateBtn.disabled = true;
        downloadBtn.disabled = true;
    </script>
</body>
</html>
